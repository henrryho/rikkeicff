var app=angular["module"]("rikkeicf",["ionic","firebase"]);app["controller"]("main",function($scope,$ionicModal,$ionicPopup,$firebaseArray){var ref= new Firebase("https://rikkeicf.firebaseio.com/users");$scope["users"]= $firebaseArray(ref);var sRef= new Firebase("https://rikkeicf.firebaseio.com/shop");$scope["sShop"]= $firebaseArray(sRef);var mRef= new Firebase("https://rikkeicf.firebaseio.com/menus");$scope["menus"]= $firebaseArray(mRef);var aRef= new Firebase("https://rikkeicf.firebaseio.com/admins");$scope["admins"]= $firebaseArray(aRef);var spRef= new Firebase("https://rikkeicf.firebaseio.com/sponsors");$scope["sponsors"]= $firebaseArray(spRef);var curIndex=0;$scope["user"]= {};$scope["choice"]= {name:"food"};var arrAdmin=[];var i=0;var j=0;var ip="";getIPs(function(ip1){if(ip1["match"](/^(192\.168\.|169\.254\.|10\.|172\.(1[6-9]|2\d|3[01]))/)){ip= ip1}});$ionicModal["fromTemplateUrl"]("detail-user-modal.html",{scope:$scope,animation:"slide-in-up"})["then"](function(modal){$scope["detailUserModal"]= modal});$scope["init"]= function(){document["getElementById"]("orderStartButton")["disabled"]= true;document["getElementById"]("orderStopButton")["disabled"]= true;document["getElementById"]("orderResetButton")["disabled"]= true;$scope["admins"].$loaded()["then"](function(){$scope["menus"].$loaded()["then"](function(){$scope["users"].$loaded()["then"](function(){updateOrderStatus("init");updateTotalOrder()})})})};function updateOrderStatus(status){switch(status){case "init":var okFlag=false;$scope["sponsorname"]= "";$scope["sponsors"].$loaded()["then"](function(){for(j= 0;j< $scope["sponsors"]["length"];j++){if(ip== $scope["sponsors"][j]["ip"]){okFlag= true};for(i= 0;i< $scope["users"]["length"];i++){if($scope["sponsors"][j]["ip"]== $scope["users"][i]["ip"]){$scope["sponsorname"]= $scope["sponsorname"]+ ", "+ $scope["users"][i]["username"]}}};if($scope["sponsorname"]!= ""){$scope["sponsorname"]= $scope["sponsorname"]["substr"](1,$scope["sponsorname"]["length"])}else {$scope["sponsorname"]= $scope["sponsors"][0]["ip"]};for(i= 0;i< $scope["admins"]["length"];i++){arrAdmin[i]= $scope["admins"][i]["ip"]};$scope["phonenumber"]= $scope["sShop"][0]["phonenumber"];if((okFlag&& $scope["sShop"][0]["sponsor_control"]== true)| arrAdmin["indexOf"](ip)!=  -1){$scope["sShop"].$loaded()["then"](function(){if($scope["sShop"][0]["active"]== true){document["getElementById"]("orderStartButton")["disabled"]= true;document["getElementById"]("orderStopButton")["disabled"]= false;document["getElementById"]("orderResetButton")["disabled"]= false}else {document["getElementById"]("orderStartButton")["disabled"]= false;document["getElementById"]("orderStopButton")["disabled"]= true;document["getElementById"]("orderResetButton")["disabled"]= false}})["catch"](function(error){alert("C\xF3 l\u1ed7i h\u1ec7 th\u1ed1ng. Vui l\xF2ng li\xEAn h\u1ec7 v\u1edbi admin.")})}});break;case "reset":document["getElementById"]("orderStartButton")["disabled"]= true;document["getElementById"]("orderStopButton")["disabled"]= false;document["getElementById"]("orderResetButton")["disabled"]= true;$scope["sShop"][0]["active"]= true;$scope["sShop"].$save(0);break;case "start":document["getElementById"]("orderStartButton")["disabled"]= true;document["getElementById"]("orderStopButton")["disabled"]= false;document["getElementById"]("orderResetButton")["disabled"]= true;$scope["sShop"][0]["active"]= true;$scope["sShop"].$save(0);break;case "stop":document["getElementById"]("orderStartButton")["disabled"]= false;document["getElementById"]("orderStopButton")["disabled"]= true;document["getElementById"]("orderResetButton")["disabled"]= false;$scope["sShop"][0]["active"]= false;$scope["sShop"].$save(0);break;default:document["getElementById"]("orderStartButton")["disabled"]= true;document["getElementById"]("orderStopButton")["disabled"]= true;document["getElementById"]("orderResetButton")["disabled"]= false;$scope["sShop"][0]["active"]= false;$scope["sShop"].$save(0)}}$scope["orderReset"]= function(){var resetPopup=$ionicPopup["confirm"]({title:"Th\xF4ng b\xE1o",template:"Reset s\u1ebd x\xF3a to\xE0n b\u1ed9 th\xF4ng tin order hi\u1ec7n c\xF3, b\u1ea1n c\xF3 ch\u1eafc ch\u1eafn mu\u1ed1n th\u1ef1c hi\u1ec7n?"});resetPopup["then"](function(res){if(res){if($scope["users"]["length"]>  -1){for(i= 0;i< $scope["users"]["length"];i++){$scope["users"][i]["order"]= "";$scope["users"][i]["quantity"]= 0;$scope["users"][i]["completed"]= false;$scope["users"].$save(i)}};if($scope["menus"]["length"]>  -1){for(i= 0;i< $scope["menus"]["length"];i++){$scope["menus"][i]["quantity"]= 0;$scope["menus"].$save(i)}};updateTotalOrder();updateOrderStatus("reset")}else {return}})};$scope["orderStart"]= function(){updateOrderStatus("start")};$scope["orderStop"]= function(){var stopPopup=$ionicPopup["alert"]({title:"Th\xF4ng b\xE1o",template:"B\u1ea1n c\xF3 th\u1ec3 cho ph\xE9p ti\u1ebfp t\u1ee5c order b\u1eb1ng c\xE1ch nh\u1ea5n v\xE0o button \"K\xEDch ho\u1ea1t Order\""});updateOrderStatus("stop")};$scope["showDetail"]= function(index){curIndex= index;if((ip== $scope["users"][curIndex]["ip"])| (arrAdmin["indexOf"](ip)!=  -1)){}else {showPopupRefuse();return};if($scope["sShop"][0]["active"]== true){$scope["detailUserModal"]["show"]();if($scope["users"][curIndex]["completed"]== true){document["getElementById"]("orderCancelButton")["disabled"]= false}else {document["getElementById"]("orderCancelButton")["disabled"]= true}}else {var confirmPopup=$ionicPopup["alert"]({title:"Th\xF4ng b\xE1o",template:"H\u1ec7 th\u1ed1ng Order ch\u01b0a \u0111\u01b0\u1ee3c k\xEDch ho\u1ea1t ho\u1eb7c \u0111\xE3 k\u1ebft th\xFAc.<p>Vui l\xF2ng li\xEAn h\u1ec7 v\u1edbi admin."})}};$scope["closeDetailUser"]= function(){updateTotalOrder();$scope["detailUserModal"]["hide"]()};$scope["orderCompleted"]= function(){if(curIndex!=  -1){$scope["users"][curIndex]["order"]= $scope["choice"]["name"];$scope["users"][curIndex]["completed"]= true;$scope["users"][curIndex]["quantity"]= 1;$scope["users"].$save(curIndex);$scope["detailUserModal"]["hide"]();updateTotalOrder()}else {return}};$scope["orderCancel"]= function(){if(curIndex!=  -1){$scope["users"][curIndex]["order"]= "";$scope["users"][curIndex]["completed"]= false;$scope["users"][curIndex]["quantity"]= 0;$scope["users"].$save(curIndex);$scope["detailUserModal"]["hide"]();updateTotalOrder()}else {return}};function updateTotalOrder(){for(var i=0;i< $scope["menus"]["length"];i++){$scope["menus"][i]["quantity"]= 0};for(var i=0;i< $scope["users"]["length"];i++){for(var j=0;j< $scope["menus"]["length"];j++){if($scope["users"][i]["order"]== $scope["menus"][j]["foodname"]){$scope["menus"][j]["quantity"]+= 1;$scope["menus"].$save(j)}}};getMoney();if($scope["sShop"].$loaded()["then"](function(){$scope["sShop"][0]["money"]= $scope["money"];$scope["sShop"].$save(0)})){;}}function getMoney(){$scope["money"]= 0;var tmpMoney=0;if($scope["menus"]["length"]>  -1){for(var i=0;i< $scope["menus"]["length"];i++){tmpMoney+= $scope["menus"][i]["quantity"]* $scope["menus"][i]["price"]}};$scope["money"]= formatMoney(tmpMoney)}$scope["showPopupAbout"]= function(){var aboutPopUp=$ionicPopup["alert"]({title:"Help",template:"Copyright by @K\u1ebb c\xF4 \u0111\u01a1n 2016"})};function showPopupRefuse(){var refusePopup=$ionicPopup["alert"]({title:"Th\xF4ng b\xE1o order b\u1ea5t h\u1ee3p ph\xE1p",template:"Xin l\u1ed7i, b\u1ea1n kh\xF4ng \u0111\u01b0\u1ee3c ph\xE9p order thay ng\u01b0\u1eddi kh\xE1c khi ch\u01b0a \u0111\u01b0\u1ee3c cho ph\xE9p.<p>Vui l\xF2ng li\u1ec7n h\u1ec7 admin."})}function getCurrentNodeName(){var cIndex=-1;var key={};ref["once"]("value",function(snapshot){snapshot["forEach"](function(childSnapshot){cIndex+= 1;if(cIndex== curIndex){key= childSnapshot["key"]();return key}})});return key}function getIPs(callback){var ip_dups={};var RTCPeerConnection=window["RTCPeerConnection"]|| window["mozRTCPeerConnection"]|| window["webkitRTCPeerConnection"];var useWebKit=!!window["webkitRTCPeerConnection"];if(!RTCPeerConnection){var win=iframe["contentWindow"];RTCPeerConnection= win["RTCPeerConnection"]|| win["mozRTCPeerConnection"]|| win["webkitRTCPeerConnection"];useWebKit= !!win["webkitRTCPeerConnection"]};var mediaConstraints={optional:[{RtpDataChannels:true}]};var servers={iceServers:[{urls:"stun:stun.services.mozilla.com"}]};var pc= new RTCPeerConnection(servers,mediaConstraints);function handleCandidate(candidate){var ip_regex=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/;var ip_addr=ip_regex["exec"](candidate)[1];if(ip_dups[ip_addr]=== undefined){callback(ip_addr)};ip_dups[ip_addr]= true}pc["onicecandidate"]= function(ice){if(ice["candidate"]){handleCandidate(ice["candidate"]["candidate"])}};pc["createDataChannel"]("");pc["createOffer"](function(result){pc["setLocalDescription"](result,function(){},function(){})},function(){});setTimeout(function(){var lines=pc["localDescription"]["sdp"]["split"]("\x0A");lines["forEach"](function(line){if(line["indexOf"]("a=candidate:")=== 0){handleCandidate(line)}})},1000)}function formatMoney(number){var array=[];var result="";var count=0;var number=number.toString();if(number["length"]< 3){return number};for(var i=number["length"]- 1;i>= 0;i--){count+= 1;array["push"](number[i]);if(count== 3&& i>= 1){array["push"](",");count= 0}};for(var i=array["length"]- 1;i>= 0;i--){result+= array[i]};return result}$scope["formatMoney"]= function(number){var array=[];var result="";var count=0;var number=number.toString();if(number["length"]< 3){return number};for(var i=number["length"]- 1;i>= 0;i--){count+= 1;array["push"](number[i]);if(count== 3&& i>= 1){array["push"](",");count= 0}};for(var i=array["length"]- 1;i>= 0;i--){result+= array[i]};return result}})